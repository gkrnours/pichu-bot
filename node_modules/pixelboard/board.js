document.on('dom:loaded', function(){
	var socket = null
	var body = document.body
	var coord = new Template("[data-row=#{y}] [data-col=#{x}]")

	var board = new Element("table", {cellspacing: 0})
	for(y=0; y<32; ++y){
		var tr = new Element("tr", {'data-row': y}).addClassName("y"+y)
		for(x=0; x<32; ++x){
			tr.insert(new Element("td", {'data-col': x}).addClassName("x"+x))
		}
		board.insert(tr)
	}
	body.insert(board)

	board.on('click', 'td', function(ev, el){
		$$(".todo" ).invoke("removeClassName", "todo" )
		el.addClassName("todo")
		x = el.getAttribute('data-col')
		y = el.up().getAttribute('data-row')
		action = (el.hasClassName('draw'))?'erase':'draw'
		socket.emit("act", {x:x, y:y, c:action})
	})

	new Ajax.Request('load', {
		onSuccess: function(req){
			data = req.responseJSON
			data.cells.each(function(item){
				elmt = $$(coord.evaluate(item)).first().className = item.c
			})
			
			socket = io.connect(data.local?"":":8000")
			socket.on("tick", function(data){
				$$(".erase"  ).invoke("removeClassName", "erase")
				$$(".todo"   ).invoke("removeClassName", "todo" )
				$$(".wannabe").invoke("removeClassName", "wannabe" )
				data.todo.each(function(item){
					elmt = $$(coord.evaluate(item)).first()
					elmt.className = item.c
					elmt.addClassName("wannabe")
				})
			})
		}
	});
})
